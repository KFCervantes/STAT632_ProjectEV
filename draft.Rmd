---
title: "Draft"
output: github_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(car)
library(dplyr)
library(ggplot2)
library(knitr)
library(magrittr)
library(tidyr)
data <- "Dataset/cleaned_data.csv" %>%
  read.csv
```

This document is meant to draft out stuff and select variables.

# Correlation Matrix

First, variables will need to be selected. In order to do this, a correlation matrix will be used to pick which variables will be kept before doing linear regression. For our purposes, we will define highly correlated as having an absolute correlation higher than 0.7.

```{r}
data %>%
  select_if(is.numeric) %>%
  cor(use = "pairwise.complete.obs") %>%
  kable
```
From this matrix, we can see that `PriceinUK` is highly correlated with the following:

* `Subtitle`

* `TopSpeed`

* `PriceinGermany`

`PriceinGermany` may be considered a different version of the response, but `Subtitle` and `TopSpeed` may be significant predictors. For this reason, other predictors correlated with these may be dropped. These predictors are:

* `Range`

* `Acceleration`

* `FastChargeSpeed`

# Scatterplot Matrix

Next a scatterplot matrix will be used to find potential transformations.

```{r}
(PriceinUK ~ .) %>%
  pairs(
    data %>%
      select_if(is.numeric) %>%
      select(-c("PriceinGermany", "Range", "Acceleration", "FastChargeSpeed"))
  )
```
In order to find the appropriate transformations, the first row will be focused on. This is because it contains `PriceinUK` as the response and the other variables as a single predictor.

Since `Subtitle` and `TopSpeed` seem to curve upwards, a quadratic transformation will be used for those.

Since `Efficiency` and `NumberofSeats` seem to have a non-constant variance, a logistic transformation will be used. Since `NumberofSeats` is always positive, the transformation `log` will work. In order to find which logistic transformation, we will have check if `Efficiency` has non-positive values.

```{r}
data %$%
  Efficiency %>%
  min
```

Since the minimum value in `Efficiency` is positive, all values in that column must be positive. This indicates that the transformation `log` will work.

# First Model

Now a model will be tested. Initially, a full model will be used and the `step` function will be used to select significant predictors using the BIC.

Before we test the model, it may help to subset the data in order to drop rows with null values for the columns we want.

```{r}
lm_data <- data %>%
  select(-c("Acceleration", "Range", "FastChargeSpeed", "PriceinGermany")) %>%
  drop_na()
```

Now that we have the desired subset, we can use it for regression.

```{r}
lm1 <- (PriceinUK ~ poly(Subtitle, 2, raw = T) + poly(TopSpeed, 2, raw = T) + log(Efficiency) + log(NumberofSeats) + Drive) %>%
  lm(lm_data) %>%
  step(
    trace = 0,
    k = lm_data %>% nrow %>% log
  )

lm1 %>%
  summary

lm1 %>%
  plot(which = 1:2)
```

In this model, the term `TopSpeed` does not seem to be significant. As such, a new model without this term will be fit and analyzed. Since the column `Drive` does not contain null values, we can reuse the same dataset.

```{r}
lm2 <- (PriceinUK ~ poly(Subtitle, 2, raw = T) + I(TopSpeed^2) + log(Efficiency) + log(NumberofSeats)) %>%
  lm(lm_data) %>%
  step(
    trace = 0,
    k = lm_data %>% nrow %>% log
  )

lm2 %>%
  summary

lm2 %>%
  plot(which = 1:2)
```

This new model only contains significant predictors, however a response transformation may be needed. In order to check this, the `powerTransform` function will be used.

```{r}
lm2 %>%
  powerTransform %>%
  summary
```

This indicates that an inverse square root transformation may be appropriate. A new version of the model with this transformation will be used and analyzed.

```{r}
lm3 <- (I(PriceinUK^-0.5) ~ poly(Subtitle, 2, raw = T) + I(TopSpeed^2) + log(Efficiency) + log(NumberofSeats)) %>%
  lm(lm_data) %>%
  step(
    trace = 0,
    k = lm_data %>% nrow %>% log
  )

lm3 %>%
  summary

lm3 %>%
  plot(which = 1:2)
```

This process has resulted in the following model:

$$
\begin{align*}
\frac{1}{\sqrt{\texttt{PriceinUK}}} = & \beta_0\\
+& \beta_1 \texttt{Subtitle} \\
+& \beta_2 \texttt{Subtitle}^2 \\
+& \beta_3 \texttt{TopSpeed}^2 \\
+& \beta_4 \ln \texttt{Efficiency} \\
+& \beta_5 \ln \texttt{NumberofSeats}
+& \epsilon
\end{align*}
$$